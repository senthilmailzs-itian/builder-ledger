# Builder Ledger - GitHub Copilot Instructions

This file provides project-specific context and rules for GitHub Copilot.

## Project Overview

Builder Ledger is an **offline-first Electron desktop application** for construction project financial management.

**Key Constraints**:
- 100% offline at runtime (internet allowed during development only)
- Windows 10/11 x64 only
- SQLite database with WAL mode
- HTML + Bootstrap 5.3 UI (local assets, no CDN)
- Role-based access: ADMIN, ACCOUNTANT, REPORT_VIEWER

## Architecture

**Layered Architecture** (strict separation):
```
UI Layer (Renderer Process)
  ↓ IPC Communication
IPC Controller Layer (Main Process)
  ↓
Service Layer (Business Logic)
  ↓
Repository Layer (Data Access)
  ↓
Database Adapter (SQLite Abstraction)
  ↓
SQLite Database
```

**Critical Rules**:
1. **No SQL in Services**: All SQL queries must be in repository layer
2. **No Business Logic in Controllers**: Controllers only route IPC requests
3. **Authorization in Services**: All permission checks in service layer (NOT in UI or controllers)
4. **UI is Defensive Only**: UI visibility is NOT a security boundary
5. **Soft Delete Everywhere**: Use `is_deleted` flag, never physical deletes
6. **Audit Trail for Ledger Only**: Track field-level changes for `ledger_entries` table only
7. **IST Timestamps**: All timestamps generated by application layer (Asia/Kolkata timezone)
8. **No sessionStorage**: Sessions in memory only, NO sessionStorage, NO localStorage, NO cookies

## Technology Stack

- **Runtime**: Electron 28.x
- **Database**: SQLite 3.x with WAL mode
- **UI**: HTML + Bootstrap 5.3 (local), Vanilla JavaScript
- **Authentication**: bcrypt for password hashing
- **Logging**: Winston
- **Packaging**: electron-builder (Windows x64 NSIS)

## Business Rules

### Ledger Entry Rules

1. Every entry MUST belong to a project
2. Entry MAY belong to a shop (nullable)
3. **Payment Received**: `shop_id` MUST be NULL
4. **Shop Payment**: `shop_id` MUST NOT be NULL, shop must be ACTIVE
5. **Refund to Customer**: `shop_id` MUST be NULL, project balance must be > 0
6. **Expense Categories**: `shop_id` is OPTIONAL

### Project/Shop Lifecycle

- **ACTIVE**: Allows mutations (subject to role permissions)
- **CLOSED**: Strictly read-only, no mutations allowed
- Only ADMIN can change status (ACTIVE ↔ CLOSED)

### Role Permissions

| Role | Permissions |
|------|-------------|
| **ADMIN** | User management, project/shop lifecycle, master data, read-only ledger, backup management |
| **ACCOUNTANT** | Ledger CRUD (on ACTIVE projects/shops), payments, refunds |
| **REPORT_VIEWER** | Read-only access to all data |

## Database Rules

### Schema Conventions

- **Primary Keys**: `id INTEGER PRIMARY KEY AUTOINCREMENT`
- **Foreign Keys**: Always define with `FOREIGN KEY (column) REFERENCES table(id)`
- **Soft Delete**: All tables have `is_deleted INTEGER NOT NULL DEFAULT 0`
- **Timestamps**: `created_at TEXT NOT NULL`, `updated_at TEXT NOT NULL`
- **Audit Fields**: `created_by`, `updated_by` (FK to users)

### Query Conventions

- Always filter by `is_deleted = 0`
- Use parameterized queries (`?` placeholders)
- Create indexes for common queries

### Timestamp Rules

- **ALL timestamps generated by application layer ONLY**
- **Timezone**: Asia/Kolkata (IST)
- **Format**: ISO-8601 with timezone offset
- **NO database-generated timestamps**
- **NO DEFAULT (datetime('now'))**
- **NO triggers**

## Security Rules

1. **Passwords**: Never store plaintext, always use bcrypt
2. **SQL Injection**: Always use parameterized queries
3. **Authorization**: Always check in service layer
4. **Sessions**: In-memory only, cleared on app restart
5. **NO sessionStorage**: Sessions NOT persisted to sessionStorage, localStorage, or cookies
6. **Audit Trail**: Immutable, insert-only for `ledger_audit_trail`
7. **Electron Security**: `contextIsolation=true`, `nodeIntegration=false`

## Repository Pattern

- Repository layer handles ALL SQL queries
- Services delegate to repositories
- No SQL in service layer
- Parameterized queries only
- Always filter by `is_deleted = 0`

## Service Layer

- Enforce authorization (check role)
- Validate business rules
- Validate inputs
- Handle errors gracefully
- Delegate SQL to repositories
- Generate IST timestamps

## IPC Controller Layer

- Register IPC handlers
- Validate session from event
- Call service methods
- Return `{success: true, data}` on success
- Return `{success: false, error: message}` on failure
- Wrap in try-catch

## Preload Script

- Use `contextBridge.exposeInMainWorld`
- Namespace: `window.api`
- Use `ipcRenderer.invoke` (not `send`)

## UI Layer

- Use Bootstrap 5.3 classes for styling
- Display errors in `alert alert-danger` div
- Handle both `result.success === false` and exceptions
- Validate inputs client-side (defensive, not authoritative)

## File Locations

- **Application**: `C:\Program Files\Builder Ledger\`
- **Database**: `C:\ProgramData\BuilderLedger\data\builder-ledger.db`
- **Backups**: `C:\ProgramData\BuilderLedger\backups\`
- **Logs**: `C:\ProgramData\BuilderLedger\logs\`
- **Attachments**: `C:\ProgramData\BuilderLedger\attachments\{year}\{month}\{entry_id}\`

## Common Mistakes to Avoid

1. ❌ **Don't put SQL in services** → Use repositories
2. ❌ **Don't skip authorization checks** → Always check role in services
3. ❌ **Don't use string concatenation for SQL** → Use parameterized queries
4. ❌ **Don't forget `is_deleted = 0` filter** → Always exclude soft-deleted records
5. ❌ **Don't validate only in UI** → Validate in service layer (UI is defensive only)
6. ❌ **Don't use CDN for Bootstrap** → Use local assets
7. ❌ **Don't physically delete records** → Use soft delete (`is_deleted = 1`)
8. ❌ **Don't expose password hashes** → Never log or return password_hash
9. ❌ **Don't use database-generated timestamps** → Generate in application layer (IST)
10. ❌ **Don't use sessionStorage** → Sessions in memory only

## Internet Usage

- **Allowed during development**: Downloading Node.js, Electron, npm packages, Git/GitHub, GitHub Copilot
- **NOT allowed at runtime**: Application must work 100% offline

## Code Style

- **Variables/Functions**: camelCase
- **Classes**: PascalCase
- **Constants**: UPPER_SNAKE_CASE
- **Private Methods**: Prefix with `_`
- **Indentation**: 2 spaces
- **Quotes**: Single quotes for strings
- **Semicolons**: Always use

---

**Last Updated**: 2026-01-15  
**Version**: 1.1
